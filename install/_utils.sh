#!/usr/bin/env bash

create_backup() {
	local file="$1"

	if [ ! -e "$file" ] || [ -L "$file" ]; then
		echo "File $file does not exist, no backup created."
		return 0
	fi
	sudo cp -f "$file" "${file}.bak" && echo "Backup created: ${file}.bak"
}

create_symlink() {
	local target="$1"
	local link_name="$2"

	create_backup "$link_name" && sudo ln -sTf "$target" "$link_name" && echo "Created symlink: $link_name -> $target"
}

create_dotfiles_symlink() {
	create_symlink "$DOTFILES_DIR/files/$1" "$2"
}

create_copy() {
	local source="$1"
	local destination="$2"

	create_backup "$destination" && sudo mkdir -pf "$(dirname "$destination")" && sudo cp -f "$source" "$destination" && echo "Copied $source to $destination"
}

create_recursive_copy() {
	local source="$1"
	local destination="$2"

	create_backup "$destination" && sudo mkdir -pf "$(dirname "$destination")" && sudo cp -rf "$source" "$destination" && echo "Recursively copied $source to $destination"
}

create_dotfiles_copy() {
	create_copy "$DOTFILES_DIR/files/$1" "$2"
}

create_dotfiles_recursive_copy() {
	create_recursive_copy "$DOTFILES_DIR/files/$1" "$2"
}

insert_content_with_marker() {
	local file="$1" marker="$2" content="$3"
	local start="# AUTOGENERATED START $marker"
	local end="# AUTOGENERATED END $marker"

	if sudo grep -q "$start" "$file" 2>/dev/null; then
		sudo sed -i "/$start/,/$end/d" "$file"
	fi

	{
		echo "$start"
		echo "$content"
		echo "$end"
	} | sudo tee -a "$file" >/dev/null

	echo "Inserted content with marker $marker in $file"
}

install_packages() {
	local packages=("$@")

	if [ ${#packages[@]} -eq 0 ]; then
		echo "No packages specified for installation."
		return 1
	fi

	echo "Installing packages: ${packages[*]}"
	sudo pacman -S --noconfirm --needed "${packages[@]}"
}

install_yay_packages() {
	local packages=("$@")

	if [ ${#packages[@]} -eq 0 ]; then
		echo "No yay packages specified for installation."
		return 1
	fi

	echo "Installing yay packages: ${packages[*]}"
	yay -S --needed "${packages[@]}"
}
